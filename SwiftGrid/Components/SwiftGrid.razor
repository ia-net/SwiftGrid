@typeparam TItem
@using Microsoft.JSInterop
@using System.Text.Json
@using System.Linq
@using global::SwiftGrid.Entities

<CascadingValue Value="this">
    <div @ref="_tableRef" class="swiftgrid-container">
        @ChildContent
    </div>
</CascadingValue>

@code {
    #region Parameters

    /// <summary>
    /// 그리드에 표시할 데이터 목록
    /// </summary>
    [Parameter]
    public IEnumerable<TItem> Data { get; set; } = Array.Empty<TItem>();

    /// <summary>
    /// 컬럼 정의를 포함하는 자식 콘텐츠
    /// </summary>
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    /// <summary>
    /// 그리드 옵션
    /// </summary>
    [Parameter]
    public SwiftGridOptions Options { get; set; } = new();

    /// <summary>
    /// 행 클릭 이벤트 콜백
    /// </summary>
    [Parameter]
    public EventCallback<TItem> OnRowClicked { get; set; }

    /// <summary>
    /// 셀 편집 완료 이벤트 콜백
    /// </summary>
    [Parameter]
    public EventCallback<CellEditedEventArgs<TItem>> OnCellEdited { get; set; }

    /// <summary>
    /// 행 선택 변경 이벤트 콜백
    /// </summary>
    [Parameter]
    public EventCallback<int> OnRowSelectionChanged { get; set; }

    #endregion

    #region Injected Services

    [Inject] 
    private IJSRuntime JS { get; set; } = default!;

    #endregion

    #region Private Fields

    private readonly List<SwiftGridColumnDefinition> _columns = new();
    private DotNetObjectReference<SwiftGrid<TItem>>? _dotNetRef;
    private ElementReference _tableRef;
    private bool _initialized;
    private bool _columnsRegistered;
    private IEnumerable<TItem>? _previousData;

    #endregion

    #region Public Methods

    /// <summary>
    /// 컬럼을 그리드에 등록합니다. (내부 사용)
    /// </summary>
    internal void RegisterColumn(SwiftGridColumnDefinition column)
    {
        if (column == null)
            throw new ArgumentNullException(nameof(column));

        column.Validate();
        _columns.Add(column);
        _columnsRegistered = true;
    }

    #endregion

    #region Lifecycle Methods

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        try
        {
            // 컬럼이 등록되지 않았거나 데이터가 없으면 초기화하지 않음
            if (!_columnsRegistered || _columns.Count == 0)
                return;

            // 테이블 초기화 (한 번만)
            if (!_initialized)
            {
                Options.Validate();
                _previousData = Data;
                await InitializeTableAsync();
                _initialized = true;
            }
            // 데이터가 변경된 경우 업데이트
            else if (!ReferenceEquals(_previousData, Data) && !AreDataEqual(_previousData, Data))
            {
                _previousData = Data;
                await UpdateDataAsync();
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"SwiftGrid: Error in OnAfterRenderAsync - {ex.Message}");
            throw;
        }
    }

    #endregion

    #region Private Methods

    /// <summary>
    /// 테이블을 초기화합니다.
    /// </summary>
    private async Task InitializeTableAsync()
    {
        try
        {
            _dotNetRef?.Dispose(); // 이전 참조가 있으면 해제
            _dotNetRef = DotNetObjectReference.Create(this);
            
            await JS.InvokeVoidAsync(
                "swiftGrid.initTable", 
                _tableRef, 
                _dotNetRef, 
                Options, 
                Data, 
                _columns
            );
        }
        catch (JSException ex)
        {
            Console.Error.WriteLine($"SwiftGrid: Failed to initialize table - {ex.Message}");
            throw new InvalidOperationException("Failed to initialize SwiftGrid. Make sure Tabulator library is loaded.", ex);
        }
    }

    /// <summary>
    /// 테이블 데이터를 업데이트합니다.
    /// </summary>
    private async Task UpdateDataAsync()
    {
        try
        {
            await JS.InvokeVoidAsync("swiftGrid.setData", _tableRef, Data);
        }
        catch (JSException ex)
        {
            Console.Error.WriteLine($"SwiftGrid: Failed to update data - {ex.Message}");
            throw;
        }
    }

    /// <summary>
    /// 두 데이터 집합이 같은지 비교합니다.
    /// </summary>
    private static bool AreDataEqual(IEnumerable<TItem>? previous, IEnumerable<TItem>? current)
    {
        if (ReferenceEquals(previous, current))
            return true;

        if (previous == null || current == null)
            return false;

        var prevList = previous.ToList();
        var currList = current.ToList();

        if (prevList.Count != currList.Count)
            return false;

        return prevList.SequenceEqual(currList);
    }

    /// <summary>
    /// 행 클릭 이벤트를 처리합니다. (JavaScript에서 호출됨)
    /// </summary>
    [JSInvokable]
    public Task HandleRowClicked(JsonElement row)
    {
        try
        {
            var item = row.Deserialize<TItem>();
            if (item != null && OnRowClicked.HasDelegate)
            {
                return OnRowClicked.InvokeAsync(item);
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"SwiftGrid: Error handling row click - {ex.Message}");
        }

        return Task.CompletedTask;
    }

    /// <summary>
    /// 셀 편집 완료 이벤트를 처리합니다. (JavaScript에서 호출됨)
    /// </summary>
    [JSInvokable]
    public Task HandleCellEdited(JsonElement cellData)
    {
        try
        {
            var field = cellData.GetProperty("field").GetString();
            var value = cellData.GetProperty("value").Deserialize<object?>();
            var oldValue = cellData.TryGetProperty("oldValue", out var oldValProp) 
                ? oldValProp.Deserialize<object?>() 
                : null;
            var row = cellData.GetProperty("row").Deserialize<TItem>();

            if (field != null && row != null && OnCellEdited.HasDelegate)
            {
                var args = new CellEditedEventArgs<TItem>
                {
                    Field = field,
                    Value = value,
                    OldValue = oldValue,
                    Row = row
                };
                return OnCellEdited.InvokeAsync(args);
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"SwiftGrid: Error handling cell edited - {ex.Message}");
        }

        return Task.CompletedTask;
    }

    /// <summary>
    /// 행 선택 변경 이벤트를 처리합니다. (JavaScript에서 호출됨)
    /// </summary>
    [JSInvokable]
    public Task HandleRowSelectionChanged(int selectedCount)
    {
        try
        {
            if (OnRowSelectionChanged.HasDelegate)
            {
                return OnRowSelectionChanged.InvokeAsync(selectedCount);
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"SwiftGrid: Error handling row selection changed - {ex.Message}");
        }

        return Task.CompletedTask;
    }

    /// <summary>
    /// 그리드가 초기화되었는지 확인합니다.
    /// </summary>
    private void EnsureInitialized()
    {
        if (!_initialized)
            throw new InvalidOperationException(
                "SwiftGrid is not initialized. " +
                "Wait until the table is rendered before calling this method."
            );
    }

    #endregion

    #region Export Methods

    /// <summary>
    /// 테이블 데이터를 파일로 다운로드합니다.
    /// </summary>
    /// <param name="type">다운로드 형식 (csv, json, xlsx, pdf, html)</param>
    /// <param name="filename">파일명 (확장자 포함 선택사항)</param>
    /// <param name="options">다운로드 옵션</param>
    /// <exception cref="InvalidOperationException">그리드가 초기화되지 않은 경우</exception>
    /// <exception cref="ArgumentException">지원하지 않는 다운로드 형식인 경우</exception>
    public async Task DownloadAsync(string type, string? filename = null, object? options = null)
    {
        EnsureInitialized();

        if (string.IsNullOrWhiteSpace(type))
            throw new ArgumentException("Download type cannot be null or empty.", nameof(type));

        var supportedTypes = new[] { "csv", "json", "xlsx", "pdf", "html" };
        if (!supportedTypes.Contains(type.ToLowerInvariant()))
            throw new ArgumentException($"Unsupported download type: {type}. Supported types: {string.Join(", ", supportedTypes)}", nameof(type));

        try
        {
            await JS.InvokeVoidAsync("swiftGrid.download", _tableRef, type, filename, options);
        }
        catch (JSException ex)
        {
            Console.Error.WriteLine($"SwiftGrid: Failed to download {type} - {ex.Message}");
            throw new InvalidOperationException($"Failed to download file as {type}. Make sure the required libraries are loaded.", ex);
        }
    }

    /// <summary>
    /// 테이블을 CSV 형식으로 다운로드합니다.
    /// </summary>
    /// <param name="filename">파일명 (기본값: "export.csv")</param>
    /// <param name="selectedOnly">선택된 행만 다운로드할지 여부</param>
    public Task DownloadCsvAsync(string? filename = null, bool selectedOnly = false)
    {
        var options = selectedOnly ? new { rows = "selected" } : null;
        return DownloadAsync("csv", filename ?? "export.csv", options);
    }

    /// <summary>
    /// 테이블을 JSON 형식으로 다운로드합니다.
    /// </summary>
    /// <param name="filename">파일명 (기본값: "export.json")</param>
    /// <param name="selectedOnly">선택된 행만 다운로드할지 여부</param>
    public Task DownloadJsonAsync(string? filename = null, bool selectedOnly = false)
    {
        var options = selectedOnly ? new { rows = "selected" } : null;
        return DownloadAsync("json", filename ?? "export.json", options);
    }

    /// <summary>
    /// 테이블을 Excel 형식으로 다운로드합니다.
    /// </summary>
    /// <param name="filename">파일명 (기본값: "export.xlsx")</param>
    /// <param name="selectedOnly">선택된 행만 다운로드할지 여부</param>
    /// <remarks>
    /// Excel 다운로드를 사용하려면 XLSX 라이브러리가 로드되어 있어야 합니다.
    /// </remarks>
    public Task DownloadExcelAsync(string? filename = null, bool selectedOnly = false)
    {
        var options = selectedOnly ? new { rows = "selected" } : null;
        return DownloadAsync("xlsx", filename ?? "export.xlsx", options);
    }

    /// <summary>
    /// 테이블을 PDF 형식으로 다운로드합니다.
    /// </summary>
    /// <param name="filename">파일명 (기본값: "export.pdf")</param>
    /// <param name="selectedOnly">선택된 행만 다운로드할지 여부</param>
    /// <remarks>
    /// PDF 다운로드를 사용하려면 jsPDF 라이브러리가 로드되어 있어야 합니다.
    /// </remarks>
    public Task DownloadPdfAsync(string? filename = null, bool selectedOnly = false)
    {
        var options = selectedOnly ? new { rows = "selected" } : null;
        return DownloadAsync("pdf", filename ?? "export.pdf", options);
    }

    /// <summary>
    /// 테이블을 HTML 형식으로 다운로드합니다.
    /// </summary>
    /// <param name="filename">파일명 (기본값: "export.html")</param>
    /// <param name="selectedOnly">선택된 행만 다운로드할지 여부</param>
    public Task DownloadHtmlAsync(string? filename = null, bool selectedOnly = false)
    {
        var options = selectedOnly ? new { rows = "selected" } : null;
        return DownloadAsync("html", filename ?? "export.html", options);
    }

    /// <summary>
    /// 테이블을 HTML 문자열로 반환합니다.
    /// </summary>
    /// <param name="options">HTML 생성 옵션</param>
    /// <returns>HTML 문자열</returns>
    /// <exception cref="InvalidOperationException">그리드가 초기화되지 않은 경우</exception>
    public async Task<string> GetHtmlAsync(object? options = null)
    {
        EnsureInitialized();

        try
        {
            return await JS.InvokeAsync<string>("swiftGrid.getHtml", _tableRef, options) ?? string.Empty;
        }
        catch (JSException ex)
        {
            Console.Error.WriteLine($"SwiftGrid: Failed to get HTML - {ex.Message}");
            throw new InvalidOperationException("Failed to get HTML. Make sure Tabulator export module is loaded.", ex);
        }
    }

    /// <summary>
    /// 테이블을 인쇄합니다.
    /// </summary>
    /// <param name="options">인쇄 옵션</param>
    /// <exception cref="InvalidOperationException">그리드가 초기화되지 않은 경우</exception>
    public async Task PrintAsync(object? options = null)
    {
        EnsureInitialized();

        try
        {
            await JS.InvokeVoidAsync("swiftGrid.print", _tableRef, options);
        }
        catch (JSException ex)
        {
            Console.Error.WriteLine($"SwiftGrid: Failed to print - {ex.Message}");
            throw new InvalidOperationException("Failed to print table. Make sure Tabulator print module is loaded.", ex);
        }
    }

    #endregion

    #region Edit and History Methods

    /// <summary>
    /// 마지막 편집을 취소합니다 (Undo).
    /// </summary>
    /// <exception cref="InvalidOperationException">그리드가 초기화되지 않았거나 히스토리가 활성화되지 않은 경우</exception>
    public async Task UndoAsync()
    {
        EnsureInitialized();

        try
        {
            await JS.InvokeVoidAsync("swiftGrid.undo", _tableRef);
        }
        catch (JSException ex)
        {
            Console.Error.WriteLine($"SwiftGrid: Failed to undo - {ex.Message}");
            throw new InvalidOperationException("Failed to undo. Make sure Tabulator history module is loaded and history is enabled.", ex);
        }
    }

    /// <summary>
    /// 마지막 취소한 편집을 다시 실행합니다 (Redo).
    /// </summary>
    /// <exception cref="InvalidOperationException">그리드가 초기화되지 않았거나 히스토리가 활성화되지 않은 경우</exception>
    public async Task RedoAsync()
    {
        EnsureInitialized();

        try
        {
            await JS.InvokeVoidAsync("swiftGrid.redo", _tableRef);
        }
        catch (JSException ex)
        {
            Console.Error.WriteLine($"SwiftGrid: Failed to redo - {ex.Message}");
            throw new InvalidOperationException("Failed to redo. Make sure Tabulator history module is loaded and history is enabled.", ex);
        }
    }

    /// <summary>
    /// Undo 가능한 히스토리 항목 수를 반환합니다.
    /// </summary>
    /// <returns>Undo 가능한 항목 수</returns>
    public async Task<int> GetHistoryUndoSizeAsync()
    {
        EnsureInitialized();

        try
        {
            return await JS.InvokeAsync<int>("swiftGrid.getHistoryUndoSize", _tableRef);
        }
        catch (JSException ex)
        {
            Console.Error.WriteLine($"SwiftGrid: Failed to get undo size - {ex.Message}");
            return 0;
        }
    }

    /// <summary>
    /// Redo 가능한 히스토리 항목 수를 반환합니다.
    /// </summary>
    /// <returns>Redo 가능한 항목 수</returns>
    public async Task<int> GetHistoryRedoSizeAsync()
    {
        EnsureInitialized();

        try
        {
            return await JS.InvokeAsync<int>("swiftGrid.getHistoryRedoSize", _tableRef);
        }
        catch (JSException ex)
        {
            Console.Error.WriteLine($"SwiftGrid: Failed to get redo size - {ex.Message}");
            return 0;
        }
    }

    #endregion

    #region Row Selection Methods

    /// <summary>
    /// 선택된 행의 데이터를 가져옵니다.
    /// </summary>
    /// <returns>선택된 행의 데이터 컬렉션</returns>
    /// <exception cref="InvalidOperationException">그리드가 초기화되지 않은 경우</exception>
    public async Task<IEnumerable<TItem>> GetSelectedDataAsync()
    {
        EnsureInitialized();

        try
        {
            var selectedData = await JS.InvokeAsync<JsonElement[]>("swiftGrid.getSelectedData", _tableRef);
            return selectedData?.Select(item => item.Deserialize<TItem>()!).Where(item => item != null) 
                   ?? Array.Empty<TItem>();
        }
        catch (JSException ex)
        {
            Console.Error.WriteLine($"SwiftGrid: Failed to get selected data - {ex.Message}");
            return Array.Empty<TItem>();
        }
    }

    /// <summary>
    /// 선택된 행 객체를 가져옵니다.
    /// </summary>
    /// <returns>선택된 행의 데이터 컬렉션</returns>
    /// <exception cref="InvalidOperationException">그리드가 초기화되지 않은 경우</exception>
    public async Task<IEnumerable<TItem>> GetSelectedRowsAsync()
    {
        EnsureInitialized();

        try
        {
            var selectedRows = await JS.InvokeAsync<JsonElement[]>("swiftGrid.getSelectedRows", _tableRef);
            return selectedRows?.Select(item => item.Deserialize<TItem>()!).Where(item => item != null) 
                   ?? Array.Empty<TItem>();
        }
        catch (JSException ex)
        {
            Console.Error.WriteLine($"SwiftGrid: Failed to get selected rows - {ex.Message}");
            return Array.Empty<TItem>();
        }
    }

    /// <summary>
    /// 행을 선택합니다.
    /// </summary>
    /// <param name="rowFilter">선택할 행 필터 (인덱스, ID, 또는 데이터 객체)</param>
    /// <exception cref="InvalidOperationException">그리드가 초기화되지 않은 경우</exception>
    public async Task SelectRowAsync(object rowFilter)
    {
        EnsureInitialized();

        try
        {
            await JS.InvokeVoidAsync("swiftGrid.selectRow", _tableRef, rowFilter);
        }
        catch (JSException ex)
        {
            Console.Error.WriteLine($"SwiftGrid: Failed to select row - {ex.Message}");
            throw new InvalidOperationException("Failed to select row. Make sure Tabulator selectRow module is loaded.", ex);
        }
    }

    /// <summary>
    /// 행 선택을 해제합니다.
    /// </summary>
    /// <param name="rowFilter">선택 해제할 행 필터 (인덱스, ID, 또는 데이터 객체)</param>
    /// <exception cref="InvalidOperationException">그리드가 초기화되지 않은 경우</exception>
    public async Task DeselectRowAsync(object rowFilter)
    {
        EnsureInitialized();

        try
        {
            await JS.InvokeVoidAsync("swiftGrid.deselectRow", _tableRef, rowFilter);
        }
        catch (JSException ex)
        {
            Console.Error.WriteLine($"SwiftGrid: Failed to deselect row - {ex.Message}");
            throw new InvalidOperationException("Failed to deselect row. Make sure Tabulator selectRow module is loaded.", ex);
        }
    }

    /// <summary>
    /// 행 선택 상태를 토글합니다.
    /// </summary>
    /// <param name="rowFilter">토글할 행 필터 (인덱스, ID, 또는 데이터 객체)</param>
    /// <exception cref="InvalidOperationException">그리드가 초기화되지 않은 경우</exception>
    public async Task ToggleSelectRowAsync(object rowFilter)
    {
        EnsureInitialized();

        try
        {
            await JS.InvokeVoidAsync("swiftGrid.toggleSelectRow", _tableRef, rowFilter);
        }
        catch (JSException ex)
        {
            Console.Error.WriteLine($"SwiftGrid: Failed to toggle row selection - {ex.Message}");
            throw new InvalidOperationException("Failed to toggle row selection. Make sure Tabulator selectRow module is loaded.", ex);
        }
    }

    #endregion

    #region Clipboard Methods

    /// <summary>
    /// 선택된 행의 데이터를 클립보드로 복사합니다.
    /// </summary>
    /// <param name="rowRange">복사 범위 ("selected", "active", "visible", "all")</param>
    /// <exception cref="InvalidOperationException">그리드가 초기화되지 않았거나 클립보드 모듈이 로드되지 않은 경우</exception>
    public async Task CopyToClipboardAsync(string? rowRange = null)
    {
        EnsureInitialized();

        try
        {
            await JS.InvokeVoidAsync("swiftGrid.copyToClipboard", _tableRef, rowRange ?? "selected");
        }
        catch (JSException ex)
        {
            Console.Error.WriteLine($"SwiftGrid: Failed to copy to clipboard - {ex.Message}");
            throw new InvalidOperationException("Failed to copy to clipboard. Make sure Tabulator clipboard module is loaded and clipboard option is enabled.", ex);
        }
    }

    #endregion

    #region Row Management Methods

    /// <summary>
    /// 행을 삭제합니다.
    /// </summary>
    /// <param name="rowFilter">삭제할 행 필터 (인덱스, ID, 배열, 또는 데이터 객체)</param>
    /// <exception cref="InvalidOperationException">그리드가 초기화되지 않은 경우</exception>
    public async Task DeleteRowAsync(object rowFilter)
    {
        EnsureInitialized();

        try
        {
            await JS.InvokeVoidAsync("swiftGrid.deleteRow", _tableRef, rowFilter);
        }
        catch (JSException ex)
        {
            Console.Error.WriteLine($"SwiftGrid: Failed to delete row - {ex.Message}");
            throw new InvalidOperationException("Failed to delete row. Make sure Tabulator is properly initialized.", ex);
        }
    }

    #endregion

    #region IDisposable Implementation

    /// <summary>
    /// 리소스를 해제합니다.
    /// </summary>
    public async ValueTask DisposeAsync()
    {
        try
        {
            if (_initialized)
            {
                await JS.InvokeVoidAsync("swiftGrid.destroyTable", _tableRef);
                _initialized = false;
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"SwiftGrid: Error disposing table - {ex.Message}");
        }
        finally
        {
            _dotNetRef?.Dispose();
            _dotNetRef = null;
        }
    }

    #endregion
}
