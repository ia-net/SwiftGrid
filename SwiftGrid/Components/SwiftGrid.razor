@* 
    SwiftGrid - Tabulator 기반 Blazor 그리드 컴포넌트
    
    사용 예시:
    <SwiftGrid TItem="Person" Data="@people" Options="@gridOptions">
        <SwiftGridColumn TItem="Person" Field="Name" Title="이름" Sortable="true" />
        <SwiftGridColumn TItem="Person" Field="Age" Title="나이" Sortable="true" />
    </SwiftGrid>
*@

@typeparam TItem
@using Microsoft.JSInterop
@using System.Text.Json
@using System.Linq
@using global::SwiftGrid.Entities
@using Microsoft.Extensions.Logging

<CascadingValue Value="this">
    <div @ref="_tableRef" class="swiftgrid-container">
        @ChildContent
    </div>
</CascadingValue>

@code {
    #region Parameters

    /// <summary>그리드에 표시할 데이터 목록</summary>
    [Parameter]
    public IEnumerable<TItem> Data { get; set; } = Array.Empty<TItem>();

    /// <summary>컬럼 정의를 포함하는 자식 콘텐츠 (SwiftGridColumn 컴포넌트들)</summary>
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    /// <summary>그리드 옵션 (레이아웃, 페이지네이션, 선택 모드 등)</summary>
    [Parameter]
    public SwiftGridOptions Options { get; set; } = new();

    /// <summary>행 클릭 이벤트 콜백</summary>
    [Parameter]
    public EventCallback<TItem> OnRowClicked { get; set; }

    /// <summary>셀 편집 완료 이벤트 콜백</summary>
    [Parameter]
    public EventCallback<CellEditedEventArgs<TItem>> OnCellEdited { get; set; }

    /// <summary>행 선택 변경 이벤트 콜백 (선택된 행 개수 전달)</summary>
    [Parameter]
    public EventCallback<int> OnRowSelectionChanged { get; set; }

    /// <summary>전체 데이터 개수 (서버 사이드 페이지네이션 사용 시 필수)</summary>
    [Parameter]
    public int? TotalCount { get; set; }

    /// <summary>쿼리 상태 변경 이벤트 콜백 (페이지네이션, 정렬, 필터, 검색 상태 변경 시 호출)</summary>
    [Parameter]
    public EventCallback<SwiftGridQuery> OnQueryChanged { get; set; }

    #endregion

    #region Injected Services

    [Inject]
    private IJSRuntime JS { get; set; } = default!;

    [Inject]
    private ILogger<SwiftGrid<TItem>> Logger { get; set; } = default!;

    #endregion

    #region Private Fields

    private readonly List<SwiftGridColumnDefinition> _columns = new();
    private DotNetObjectReference<SwiftGrid<TItem>>? _dotNetRef;
    private ElementReference _tableRef;
    private bool _initialized;
    private bool _columnsRegistered;
    private IEnumerable<TItem>? _previousData;

    #endregion

    #region Public Methods

    /// <summary>컬럼을 그리드에 등록합니다 (SwiftGridColumn 컴포넌트에서 자동 호출)</summary>
    internal void RegisterColumn(SwiftGridColumnDefinition column)
    {
        ArgumentNullException.ThrowIfNull(column);
        
        column.Validate();
        _columns.Add(column);
        _columnsRegistered = true;
    }

    #endregion

    #region Lifecycle Methods

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        try
        {
            if (!_columnsRegistered || _columns.Count == 0)
                return;

            if (!_initialized)
            {
                Options.Validate();
                _previousData = Data;
                await InitializeTableAsync();
                _initialized = true;
            }
            else if (!ReferenceEquals(_previousData, Data) && !AreDataEqual(_previousData, Data))
            {
                _previousData = Data;
                await UpdateDataAsync();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error in OnAfterRenderAsync");
            throw;
        }
    }

    #endregion

    #region Private Methods

    private async Task InitializeTableAsync()
    {
        _dotNetRef?.Dispose();
        _dotNetRef = DotNetObjectReference.Create(this);

        await InvokeJsSafelyAsync(
            "swiftGrid.initTable",
            _tableRef,
            _dotNetRef,
            Options,
            Data,
            _columns,
            errorMessage: "SwiftGrid 초기화에 실패했습니다. Tabulator 라이브러리가 로드되어 있는지 확인하세요.");
    }

    private async Task UpdateDataAsync()
    {
        await InvokeJsSafelyAsync(
            "swiftGrid.setData",
            _tableRef,
            Data,
            errorMessage: "데이터 업데이트에 실패했습니다. 그리드가 올바르게 초기화되었는지 확인하세요.");
    }

    private static bool AreDataEqual(IEnumerable<TItem>? previous, IEnumerable<TItem>? current)
    {
        if (ReferenceEquals(previous, current))
            return true;

        if (previous == null || current == null)
            return false;

        var prevList = previous.ToList();
        var currList = current.ToList();

        if (prevList.Count != currList.Count)
            return false;

        return prevList.SequenceEqual(currList);
    }

    /// <summary>JavaScript Interop 호출을 안전하게 실행하는 헬퍼 메서드</summary>
    private async Task InvokeJsSafelyAsync(string identifier, ElementReference elementRef, object? arg0 = null, object? arg1
    = null, object? arg2 = null, object? arg3 = null, object? arg4 = null, string? errorMessage = null)
    {
        try
        {
            var args = new[] { arg0, arg1, arg2, arg3, arg4 }
            .Where(arg => arg != null)
            .ToArray();

            if (args.Length == 0)
            {
                await JS.InvokeVoidAsync(identifier, elementRef);
            }
            else if (args.Length == 1)
            {
                await JS.InvokeVoidAsync(identifier, elementRef, args[0]);
            }
            else if (args.Length == 2)
            {
                await JS.InvokeVoidAsync(identifier, elementRef, args[0], args[1]);
            }
            else if (args.Length == 3)
            {
                await JS.InvokeVoidAsync(identifier, elementRef, args[0], args[1], args[2]);
            }
            else if (args.Length == 4)
            {
                await JS.InvokeVoidAsync(identifier, elementRef, args[0], args[1], args[2], args[3]);
            }
            else
            {
                await JS.InvokeVoidAsync(identifier, elementRef, args[0], args[1], args[2], args[3], args[4]);
            }
        }
        catch (JSException ex)
        {
            Logger.LogError(ex, "JS call failed: {Identifier}", identifier);
            throw new InvalidOperationException(errorMessage ?? $"JavaScript 호출 실패: {identifier}", ex);
        }
    }

    /// <summary>JavaScript Interop 호출을 안전하게 실행하고 결과를 반환하는 헬퍼 메서드</summary>
    private async Task<T> InvokeJsSafelyAsync<T>(string identifier, ElementReference elementRef, object? arg0 = null,
    object? arg1 = null, T defaultValue = default!)
    {
        try
        {
            if (arg0 == null && arg1 == null)
            {
                return await JS.InvokeAsync<T>(identifier, elementRef);
            }
            else if (arg1 == null)
            {
                return await JS.InvokeAsync<T>(identifier, elementRef, arg0);
            }
            else
            {
                return await JS.InvokeAsync<T>(identifier, elementRef, arg0, arg1);
            }
        }
        catch (JSException ex)
        {
            Logger.LogWarning(ex, "JS call failed: {Identifier}, returning default value", identifier);
            return defaultValue;
        }
    }

    /// <summary>다운로드 옵션을 생성하는 헬퍼 메서드</summary>
    private static object? CreateDownloadOptions(bool selectedOnly) => selectedOnly ? new { rows = "selected" } : null;

    [JSInvokable]
    public Task HandleRowClicked(JsonElement row)
    {
        try
        {
            var item = row.Deserialize<TItem>();
            if (item != null && OnRowClicked.HasDelegate)
            {
                return OnRowClicked.InvokeAsync(item);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error handling row click event");
        }
        return Task.CompletedTask;
    }

    [JSInvokable]
    public Task HandleCellEdited(JsonElement cellData)
    {
        try
        {
            var field = cellData.GetProperty("field").GetString();
            var value = cellData.GetProperty("value").Deserialize<object?>();
            var oldValue = cellData.TryGetProperty("oldValue", out var oldValProp)
            ? oldValProp.Deserialize<object?>()
            : null;
            var row = cellData.GetProperty("row").Deserialize<TItem>();

            if (field != null && row != null && OnCellEdited.HasDelegate)
            {
                var args = new CellEditedEventArgs<TItem>
                {
                    Field = field,
                    Value = value,
                    OldValue = oldValue,
                    Row = row
                };
                return OnCellEdited.InvokeAsync(args);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error handling cell edited event");
        }
        return Task.CompletedTask;
    }

    [JSInvokable]
    public Task HandleRowSelectionChanged(int selectedCount)
    {
        try
        {
            if (OnRowSelectionChanged.HasDelegate)
            {
                return OnRowSelectionChanged.InvokeAsync(selectedCount);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error handling row selection changed event");
        }
        return Task.CompletedTask;
    }

    [JSInvokable]
    public Task HandleQueryChanged(JsonElement queryJson)
    {
        try
        {
            if (!OnQueryChanged.HasDelegate)
            {
                Logger.LogDebug("OnQueryChanged has no delegate");
                return Task.CompletedTask;
            }

            var options = new JsonSerializerOptions { PropertyNameCaseInsensitive = true };
            var query = queryJson.Deserialize<SwiftGridQuery>(options);

            if (query == null)
            {
                Logger.LogWarning("Failed to deserialize query - query is null");
                return Task.CompletedTask;
            }

            ConvertLegacyQueryProperties(query);

            Logger.LogDebug(
            "Query changed - Page={Page}, PageSize={PageSize}, Sorts={SortCount}, Filters={FilterCount}",
            query.Page, query.PageSize, query.Sorts?.Count ?? 0, query.Filters?.Count ?? 0);

            return OnQueryChanged.InvokeAsync(query);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error handling query changed event");
        }
        return Task.CompletedTask;
    }

    private static void ConvertLegacyQueryProperties(SwiftGridQuery query)
    {
        // JSON deserializer와 SwiftGridFilter/SwiftGridSort의 속성이 자동 변환 처리
    }

    private void EnsureInitialized()
    {
        if (!_initialized)
        {
            throw new InvalidOperationException(
            "SwiftGrid가 아직 초기화되지 않았습니다. " +
            "그리드가 완전히 렌더링된 후에 이 메서드를 호출하세요.");
        }
    }

    #endregion

    #region Export Methods

    /// <summary>테이블 데이터를 파일로 다운로드합니다</summary>
    /// <param name="type">다운로드 형식 (csv, json, xlsx, pdf, html)</param>
    /// <param name="filename">파일명</param>
    /// <param name="options">다운로드 옵션</param>
    public async Task DownloadAsync(string type, string? filename = null, object? options = null)
    {
        EnsureInitialized();

        if (string.IsNullOrWhiteSpace(type))
        {
            throw new ArgumentException(
            "다운로드 형식을 지정해야 합니다. 지원하는 형식: csv, json, xlsx, pdf, html",
            nameof(type));
        }

        var supportedTypes = new[] { "csv", "json", "xlsx", "pdf", "html" };
        if (!supportedTypes.Contains(type.ToLowerInvariant()))
        {
            throw new ArgumentException(
            $"지원하지 않는 다운로드 형식입니다: '{type}'. " +
            $"지원하는 형식: {string.Join(", ", supportedTypes)}",
            nameof(type));
        }

        try
        {
            await JS.InvokeVoidAsync("swiftGrid.download", _tableRef, type, filename, options);
        }
        catch (JSException ex)
        {
            Logger.LogError(ex, "Failed to download as {DownloadType}. Required library may not be loaded.", type);
            throw new InvalidOperationException(
            $"{type.ToUpperInvariant()} 형식으로 다운로드하는데 실패했습니다. " +
            $"필요한 라이브러리가 로드되어 있는지 확인하세요.", ex);
        }
    }

    /// <summary>CSV 형식으로 다운로드</summary>
    public Task DownloadCsvAsync(string? filename = null, bool selectedOnly = false)
    => DownloadAsync("csv", filename ?? "export.csv", CreateDownloadOptions(selectedOnly));

    /// <summary>JSON 형식으로 다운로드</summary>
    public Task DownloadJsonAsync(string? filename = null, bool selectedOnly = false)
    => DownloadAsync("json", filename ?? "export.json", CreateDownloadOptions(selectedOnly));

    /// <summary>Excel 형식으로 다운로드 (XLSX 라이브러리 필요)</summary>
    public Task DownloadExcelAsync(string? filename = null, bool selectedOnly = false)
    => DownloadAsync("xlsx", filename ?? "export.xlsx", CreateDownloadOptions(selectedOnly));

    /// <summary>PDF 형식으로 다운로드 (jsPDF 라이브러리 필요)</summary>
    public Task DownloadPdfAsync(string? filename = null, bool selectedOnly = false)
    => DownloadAsync("pdf", filename ?? "export.pdf", CreateDownloadOptions(selectedOnly));

    /// <summary>HTML 형식으로 다운로드</summary>
    public Task DownloadHtmlAsync(string? filename = null, bool selectedOnly = false)
    => DownloadAsync("html", filename ?? "export.html", CreateDownloadOptions(selectedOnly));

    /// <summary>테이블을 HTML 문자열로 반환</summary>
    public async Task<string> GetHtmlAsync(object? options = null)
    {
        EnsureInitialized();
        return await InvokeJsSafelyAsync<string>(
        "swiftGrid.getHtml",
        _tableRef,
        options,
        defaultValue: string.Empty);
    }

    /// <summary>테이블을 인쇄</summary>
    public async Task PrintAsync(object? options = null)
    {
        EnsureInitialized();
        
        await InvokeJsSafelyAsync(
            "swiftGrid.print",
            _tableRef,
            options,
            errorMessage: "인쇄에 실패했습니다. Tabulator print 모듈이 로드되어 있는지 확인하세요.");
    }

    #endregion

    #region Edit and History Methods

    /// <summary>마지막 편집을 취소 (Undo) - History 옵션이 활성화되어 있어야 함</summary>
    public async Task UndoAsync()
    {
        EnsureInitialized();
        await InvokeJsSafelyAsync(
            "swiftGrid.undo",
            _tableRef,
            errorMessage: "Undo 작업에 실패했습니다. History 옵션이 활성화되어 있는지 확인하세요.");
    }

    /// <summary>마지막 취소한 편집을 다시 실행 (Redo) - History 옵션이 활성화되어 있어야 함</summary>
    public async Task RedoAsync()
    {
        EnsureInitialized();
        await InvokeJsSafelyAsync(
            "swiftGrid.redo",
            _tableRef,
            errorMessage: "Redo 작업에 실패했습니다. History 옵션이 활성화되어 있는지 확인하세요.");
    }

    /// <summary>Undo 가능한 히스토리 항목 수 반환</summary>
    public async Task<int> GetHistoryUndoSizeAsync()
    {
        EnsureInitialized();
        return await InvokeJsSafelyAsync<int>("swiftGrid.getHistoryUndoSize", _tableRef);
    }

    /// <summary>Redo 가능한 히스토리 항목 수 반환</summary>
    public async Task<int> GetHistoryRedoSizeAsync()
    {
        EnsureInitialized();
        return await InvokeJsSafelyAsync<int>("swiftGrid.getHistoryRedoSize", _tableRef);
    }

    #endregion

    #region Row Selection Methods

    /// <summary>선택된 행의 데이터를 가져옵니다</summary>
    public async Task<IEnumerable<TItem>> GetSelectedDataAsync()
    {
        EnsureInitialized();
        var selectedData = await InvokeJsSafelyAsync<JsonElement[]>("swiftGrid.getSelectedData", _tableRef);
        return selectedData?.Select(item => item.Deserialize<TItem>()!)
        .Where(item => item != null)
        ?? Array.Empty<TItem>();
    }

    /// <summary>선택된 행 객체를 가져옵니다</summary>
    public async Task<IEnumerable<TItem>> GetSelectedRowsAsync()
    {
        EnsureInitialized();
        var selectedRows = await InvokeJsSafelyAsync<JsonElement[]>("swiftGrid.getSelectedRows", _tableRef);
        return selectedRows?.Select(item => item.Deserialize<TItem>()!)
        .Where(item => item != null)
        ?? Array.Empty<TItem>();
    }

    /// <summary>행을 선택합니다</summary>
    public async Task SelectRowAsync(object rowFilter)
    {
        EnsureInitialized();
        await InvokeJsSafelyAsync(
            "swiftGrid.selectRow",
            _tableRef,
            rowFilter,
            errorMessage: "행 선택에 실패했습니다. Tabulator selectRow 모듈이 로드되어 있는지 확인하세요.");
    }

    /// <summary>행 선택을 해제합니다</summary>
    public async Task DeselectRowAsync(object rowFilter)
    {
        EnsureInitialized();
        await InvokeJsSafelyAsync(
            "swiftGrid.deselectRow",
            _tableRef,
            rowFilter,
            errorMessage: "행 선택 해제에 실패했습니다. Tabulator selectRow 모듈이 로드되어 있는지 확인하세요.");
    }

    /// <summary>행 선택 상태를 토글합니다</summary>
    public async Task ToggleSelectRowAsync(object rowFilter)
    {
        EnsureInitialized();
        await InvokeJsSafelyAsync(
            "swiftGrid.toggleSelectRow",
            _tableRef,
            rowFilter,
            errorMessage: "행 선택 토글에 실패했습니다. Tabulator selectRow 모듈이 로드되어 있는지 확인하세요.");
    }

    #endregion

    #region Clipboard Methods

    /// <summary>선택된 행의 데이터를 클립보드로 복사</summary>
    /// <param name="rowRange">복사 범위 ("selected", "active", "visible", "all")</param>
    public async Task CopyToClipboardAsync(string? rowRange = null)
    {
        EnsureInitialized();
        await InvokeJsSafelyAsync(
            "swiftGrid.copyToClipboard",
            _tableRef,
            rowRange ?? "selected",
            errorMessage: "클립보드 복사에 실패했습니다. Tabulator clipboard 모듈이 로드되어 있는지 확인하세요.");
    }

    #endregion

    #region Search and Filter Methods

    /// <summary>모든 컬럼에서 전역 검색을 수행합니다</summary>
    public async Task SearchAllAsync(string? searchValue, string? filterType = null)
    {
        EnsureInitialized();
        await InvokeJsSafelyAsync(
            "swiftGrid.searchAll",
            _tableRef,
            searchValue ?? "",
            filterType,
            errorMessage: "검색에 실패했습니다.");
    }

    #endregion

    #region Row Management Methods

    /// <summary>행을 삭제합니다</summary>
    public async Task DeleteRowAsync(object rowFilter)
    {
        EnsureInitialized();
        await InvokeJsSafelyAsync(
            "swiftGrid.deleteRow",
            _tableRef,
            rowFilter,
            errorMessage: "행 삭제에 실패했습니다. Tabulator가 올바르게 초기화되었는지 확인하세요.");
    }

    #endregion

    #region IDisposable Implementation

    public async ValueTask DisposeAsync()
    {
        try
        {
            if (_initialized)
            {
                await JS.InvokeVoidAsync("swiftGrid.destroyTable", _tableRef);
                _initialized = false;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error disposing table");
        }
        finally
        {
            _dotNetRef?.Dispose();
            _dotNetRef = null;
        }
    }

    #endregion
}
