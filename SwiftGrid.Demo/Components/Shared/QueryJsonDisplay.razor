@using SwiftGrid.Entities
@using System.Text.Encodings.Web
@using Microsoft.JSInterop
@inject IJSRuntime JS

<div class="docs-section">
    <div class="docs-section-header">
        <h2 class="docs-section-title">쿼리 JSON</h2>
        <button class="docs-button-icon" @onclick="ToggleExpanded" type="button" title="접기/펼치기">
            <i class="bi bi-chevron-@(IsExpanded ? "up" : "down")"></i>
        </button>
    </div>
    @if (IsExpanded)
    {
        <FluentCard>
            <div style="display: flex; flex-direction: column; gap: 16px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <strong style="font-size: 0.875rem; font-weight: 600; color: var(--neutral-foreground-rest);">JSON 데이터</strong>
                    <FluentButton Appearance="Appearance.Neutral" @onclick="CopyToClipboard" Title="JSON 복사">
                        <i class="bi bi-clipboard"></i>
                        복사
                    </FluentButton>
                </div>
                <div style="position: relative;">
                    @if (ShowCopyMessage)
                    {
                        <FluentMessageBar Intent="MessageIntent.Success" Style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10;">
                            클립보드에 복사되었습니다!
                        </FluentMessageBar>
                    }
                    <pre style="margin: 0; padding: 1.5rem; background-color: #1e1e1e; color: #d4d4d4; border-radius: 4px; overflow-x: auto; font-family: 'Consolas', 'Monaco', 'Courier New', monospace; font-size: 0.875rem; line-height: 1.6; max-height: 300px; overflow-y: auto;"><code>@QueryJson</code></pre>
                </div>
                <p style="font-size: 0.75rem; color: var(--neutral-foreground-rest); margin: 0;">
                    <i class="bi bi-info-circle" style="margin-right: 0.5rem;"></i>
                    @InfoText
                </p>
            </div>
        </FluentCard>
    }
</div>

@code {
    [Parameter]
    public SwiftGridQuery? Query { get; set; }

    [Parameter]
    public string InfoText { get; set; } = "서버로 전송할 데이터 형식";

    [Parameter]
    public bool DefaultExpanded { get; set; } = true;

    private bool IsExpanded { get; set; } = true;
    private bool ShowCopyMessage { get; set; } = false;
    private string QueryJson { get; set; } = "{}";

    protected override void OnParametersSet()
    {
        IsExpanded = DefaultExpanded;
        UpdateJson();
    }

    private void UpdateJson()
    {
        if (Query != null)
        {
            QueryJson = System.Text.Json.JsonSerializer.Serialize(Query, new System.Text.Json.JsonSerializerOptions
            {
                WriteIndented = true,
                Encoder = JavaScriptEncoder.UnsafeRelaxedJsonEscaping
            });
        }
        else
        {
            QueryJson = "{}";
        }
    }

    private void ToggleExpanded()
    {
        IsExpanded = !IsExpanded;
    }

    private async Task CopyToClipboard()
    {
        try
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", QueryJson);
            ShowCopyMessage = true;
            await Task.Delay(2000);
            ShowCopyMessage = false;
            StateHasChanged();
        }
        catch
        {
            // 클립보드 복사 실패 시 무시
        }
    }
}

