@page "/counter"
@rendermode InteractiveServer
@using SwiftGrid.Components
@using SwiftGrid.Entities

<h3>SwiftGrid / Tabulator Demo</h3>

<p>행 개수: @People.Count</p>

<div style="margin-bottom: 10px;">
    <button class="btn btn-success me-2" @onclick="Undo" disabled="@(!canUndo)">Undo (Ctrl+Z)</button>
    <button class="btn btn-success me-2" @onclick="Redo" disabled="@(!canRedo)">Redo (Ctrl+Y)</button>
    <span class="me-3"></span>
    <button class="btn btn-info me-2" @onclick="CopySelectedToClipboard" disabled="@(selectedCount == 0)">클립보드 복사
        (@selectedCount)</button>
    <span class="me-3"></span>
    <button class="btn btn-primary me-2" @onclick="ExportToCsv">전체 CSV</button>
    <button class="btn btn-primary me-2" @onclick="ExportSelectedToCsv" disabled="@(selectedCount == 0)">선택 CSV
        (@selectedCount)</button>
    <button class="btn btn-primary me-2" @onclick="ExportToExcel">전체 Excel</button>
    <button class="btn btn-primary me-2" @onclick="ExportSelectedToExcel" disabled="@(selectedCount == 0)">선택
        Excel</button>
    <button class="btn btn-primary me-2" @onclick="ExportToJson">JSON 다운로드</button>
    <button class="btn btn-secondary me-2" @onclick="PrintTable">인쇄</button>
</div>

<SwiftGrid @ref="gridRef" TItem="Person" Data="@People" Options="@GridOptions" OnRowClicked="RowClicked"
    OnCellEdited="HandleCellEdited" OnRowSelectionChanged="HandleRowSelectionChanged">
    <SwiftGridColumn TItem="Person" Field="Id" Title="ID" Sortable="true" Width="80" HeaderFilter="true"
        HeaderFilterPlaceholder="ID 검색..." Editable="false" />
    <SwiftGridColumn TItem="Person" Field="Name" Title="이름" Sortable="true" HeaderFilter="true"
        HeaderFilterPlaceholder="이름 검색..." Editable="true" Editor="input" />
    <SwiftGridColumn TItem="Person" Field="Age" Title="나이" Sortable="true" HeaderFilter="true"
        HeaderFilterPlaceholder="나이 검색..." Editable="true" Editor="number" />
    <SwiftGridColumn TItem="Person" Field="Email" Title="Email" HeaderFilter="true" HeaderFilterPlaceholder="이메일 검색..."
        Editable="true" Editor="input" />
</SwiftGrid>

@if (SelectedPerson is not null)
{
    <p>
        선택된 행: @SelectedPerson.Id / @SelectedPerson.Name (@SelectedPerson.Age) |
        선택된 행 수: <strong>@selectedCount</strong>
    </p>
}

@code {
    private List<Person> People = new()
{
new Person { Id = 1, Name = "홍길동", Age = 24, Email = "hong@test.com" },
new Person { Id = 2, Name = "김철수", Age = 31, Email = "kim@test.com" },
new Person { Id = 3, Name = "이영희", Age = 28, Email = "lee@test.com" },
new Person { Id = 4, Name = "박민수", Age = 35, Email = "park@test.com" },
new Person { Id = 5, Name = "최지영", Age = 27, Email = "choi@test.com" },
new Person { Id = 6, Name = "정수진", Age = 32, Email = "jung@test.com" },
new Person { Id = 7, Name = "강동원", Age = 29, Email = "kang@test.com" },
new Person { Id = 8, Name = "윤서연", Age = 26, Email = "yoon@test.com" },
new Person { Id = 9, Name = "임태현", Age = 33, Email = "lim@test.com" },
new Person { Id = 10, Name = "한소희", Age = 25, Email = "han@test.com" },
new Person { Id = 11, Name = "송혜교", Age = 30, Email = "song@test.com" },
new Person { Id = 12, Name = "이민호", Age = 28, Email = "lee2@test.com" }
};

    private SwiftGridOptions GridOptions = new()
    {
        Layout = "fitColumns",
        Height = "400px",
        Selectable = 100, // 다중 행 선택 가능 (최대 100개)
        Pagination = true,
        PaginationSize = 5,
        PaginationCounter = true,
        PaginationSizeSelector = true,
        History = true, // Undo/Redo 활성화
        Clipboard = true, // 클립보드 복사 활성화
        EnableRowSelectionCheckbox = true, // 체크박스를 통한 행 선택 활성화
        RowSelectionRange = "visible" // 전체 선택 체크박스 클릭 시 선택 범위
    };

    private Person? SelectedPerson;
    private SwiftGrid<Person>? gridRef;
    private bool canUndo = false;
    private bool canRedo = false;
    private int selectedCount = 0;

    private async Task RowClicked(Person person)
    {
        SelectedPerson = person;
        await UpdateSelectedCount();
        StateHasChanged();
        Console.WriteLine($"Row clicked: {person.Id} / {person.Name}");
    }

    private async Task ExportToCsv()
    {
        if (gridRef != null)
        {
            await gridRef.DownloadCsvAsync("people.csv");
        }
    }

    private async Task ExportToExcel()
    {
        if (gridRef != null)
        {
            await gridRef.DownloadExcelAsync("people.xlsx");
        }
    }

    private async Task ExportToJson()
    {
        if (gridRef != null)
        {
            await gridRef.DownloadJsonAsync("people.json");
        }
    }

    private async Task CopySelectedToClipboard()
    {
        if (gridRef != null)
        {
            await gridRef.CopyToClipboardAsync("selected");
            Console.WriteLine($"선택된 {selectedCount}개 행이 클립보드에 복사되었습니다.");
        }
    }

    private async Task ExportSelectedToCsv()
    {
        if (gridRef != null)
        {
            await gridRef.DownloadCsvAsync("selected_people.csv", selectedOnly: true);
        }
    }

    private async Task ExportSelectedToExcel()
    {
        if (gridRef != null)
        {
            await gridRef.DownloadExcelAsync("selected_people.xlsx", selectedOnly: true);
        }
    }

    private async Task UpdateSelectedCount()
    {
        if (gridRef != null)
        {
            var selectedData = await gridRef.GetSelectedDataAsync();
            selectedCount = selectedData.Count();
            StateHasChanged();
        }
    }

    private async Task ExportToPdf()
    {
        if (gridRef != null)
        {
            await gridRef.DownloadPdfAsync("people.pdf");
        }
    }

    private async Task PrintTable()
    {
        if (gridRef != null)
        {
            await gridRef.PrintAsync();
        }
    }

    private async Task Undo()
    {
        if (gridRef != null)
        {
            await gridRef.UndoAsync();
            await UpdateHistoryButtons();
        }
    }

    private async Task Redo()
    {
        if (gridRef != null)
        {
            await gridRef.RedoAsync();
            await UpdateHistoryButtons();
        }
    }

    private async Task HandleCellEdited(CellEditedEventArgs<Person> args)
    {
        Console.WriteLine($"Cell edited: {args.Field} = {args.OldValue} -> {args.Value}");

        // 편집된 데이터를 실제 데이터 소스에 반영
        var row = People.FirstOrDefault(p => p.Id == args.Row.Id);
        if (row != null)
        {
            switch (args.Field.ToLower())
            {
                case "name":
                    row.Name = args.Value?.ToString() ?? "";
                    break;
                case "age":
                    if (int.TryParse(args.Value?.ToString(), out int age))
                        row.Age = age;
                    break;
                case "email":
                    row.Email = args.Value?.ToString() ?? "";
                    break;
            }
        }

        await UpdateHistoryButtons();
        StateHasChanged();
    }

    private async Task UpdateHistoryButtons()
    {
        if (gridRef != null)
        {
            canUndo = await gridRef.GetHistoryUndoSizeAsync() > 0;
            canRedo = await gridRef.GetHistoryRedoSizeAsync() > 0;
        }
    }

    private Task HandleRowSelectionChanged(int selectedCount)
    {
        this.selectedCount = selectedCount;
        StateHasChanged();
        return Task.CompletedTask;
    }

    public class Person
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
        public int Age { get; set; }
        public string Email { get; set; } = "";
    }
}
